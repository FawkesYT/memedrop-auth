<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeDrop Auth - Google</title>
    <style>
        body { font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f0f0; text-align: center; }
        .container { padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; margin: 0 auto 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { color: #333; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <p id="status-message">Processing authentication...</p>
        <p><small>This window should close automatically.</small></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8", 
            authDomain: "test-6336a.firebaseapp.com", 
            databaseURL: "https://test-6336a-default-rtdb.firebaseio.com", 
            projectId: "test-6336a", 
            storageBucket: "test-6336a.appspot.com", 
            messagingSenderId: "437879418972", 
            appId: "1:437879418972:web:47678bb0b3664edab8f699" 
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const SESSION_KEY = 'memedrop_awaiting_google_redirect_v3'; 
        const statusMessageEl = document.getElementById('status-message');

        console.log("AUTH.HTML: Helper Loaded. Firebase Initialized.");
        console.log("AUTH.HTML: URL is", window.location.href);

        const postMessageToOpener = (message) => { /* ... same as before ... */ };
        const isAwaitingRedirect = sessionStorage.getItem(SESSION_KEY);
        console.log("AUTH.HTML: isAwaitingRedirect flag from sessionStorage ('"+SESSION_KEY+"'):", isAwaitingRedirect);

        if (isAwaitingRedirect === 'true') {
            console.log("AUTH.HTML: Return trip detected.");
            statusMessageEl.textContent = "Finalizing Google sign-in...";
            sessionStorage.removeItem(SESSION_KEY); 

            auth.getRedirectResult()
                .then((result) => {
                    console.log("AUTH.HTML: getRedirectResult.then() entered. Full result object:", JSON.stringify(result, null, 2)); 
                    if (result && result.credential) {
                        const credential = result.credential.toJSON(); 
                        console.log("AUTH.HTML: SUCCESS! Credential found:", JSON.stringify(credential, null, 2));
                        postMessageToOpener({ type: 'authSuccess', payload: { credential } });
                        statusMessageEl.textContent = "Sign-in successful! Closing window...";
                    } else {
                        let userDetail = "null";
                        if (result && result.user) {
                            userDetail = JSON.stringify({uid: result.user.uid, displayName: result.user.displayName, email: result.user.email}, null, 2);
                        }
                        console.warn("AUTH.HTML: getRedirectResult.then() - result is null, or no credential. User detail from result:", userDetail);
                        postMessageToOpener({ type: 'authError', message: "Authentication cancelled or no redirect result found (Firebase result or credential was null)." });
                        statusMessageEl.textContent = "Sign-in cancelled or failed. Please try again from the main app.";
                        statusMessageEl.classList.add("error");
                    }
                })
                .catch((error) => {
                    console.error("AUTH.HTML: CATCH block for getRedirectResult. Error object:", JSON.stringify({ message: error.message, code: error.code, name: error.name, stack: error.stack }, null, 2));
                    postMessageToOpener({ type: 'authError', message: error.message || "An unknown error occurred during sign-in.", code: error.code });
                    statusMessageEl.textContent = `Sign-in error: ${error.message}. You can close this window.`;
                    statusMessageEl.classList.add("error");
                })
                .finally(() => {
                    console.log("AUTH.HTML: Closing window after return trip processing (attempting).");
                    setTimeout(() => { if (window.opener) { window.close(); } }, 2500); 
                });
        } else {
            console.log("AUTH.HTML: Initial trip detected.");
            try {
                const params = new URLSearchParams(window.location.search);
                const providerName = params.get('provider');
                console.log("AUTH.HTML: Requested provider from URL params:", providerName);
                if (providerName === 'google') {
                    statusMessageEl.textContent = "Redirecting to Google for sign-in...";
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.setCustomParameters({});
                    console.log("AUTH.HTML: Setting session flag ('"+SESSION_KEY+"' = 'true') and initiating signInWithRedirect to Google.");
                    sessionStorage.setItem(SESSION_KEY, 'true'); 
                    auth.signInWithRedirect(provider);
                } else {
                    throw new Error(`Unsupported or no authentication provider specified. Expected "google", got "${providerName || 'nothing'}".`);
                }
            } catch (error) {
                console.error("AUTH.HTML: Error during initial setup:", error);
                statusMessageEl.textContent = `Setup error: ${error.message}. Please close this window.`;
                statusMessageEl.classList.add("error");
                postMessageToOpener({ type: 'authError', message: error.message || "Auth helper setup failed." });
                console.log("AUTH.HTML: Closing window due to setup error (attempting).");
                 setTimeout(() => { if (window.opener) { window.close(); } }, 3000);
            }
        }
    </script>
</body>
</html>
