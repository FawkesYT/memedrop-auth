<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeDrop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@600&display=swap" rel="stylesheet">
    <style>
        /* All necessary CSS is included here. This block is large. */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastIn { from { transform: translate(-50%, 100px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes toastOut { from { transform: translate(-50%, 0); opacity: 1; } to { transform: translate(-50%, 100px); opacity: 0; } }
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745; --error-color: #dc3545;
            --light-gray: #f0f2f5; --border-color: #ddd; --text-color: #1c1e21;
            --bg-color: #f9f9f9; --card-bg-color: #fff; --header-bg-color: #ffffffcc;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; --font-code: 'Source Code Pro', monospace;
        }
        body[data-theme="dark"] {
            --primary-color: #0d8eff; --secondary-color: #8899a6; --light-gray: #121212; --border-color: #333; --text-color: #e0e0e0;
            --bg-color: #1a1a1a; --card-bg-color: #242424; --header-bg-color: #1a1a1acc;
        }
        body[data-theme="vaporwave"] {
            --primary-color: #ff71ce; --secondary-color: #01cdfe; --light-gray: #242448; --border-color: #4a4a88; --text-color: #01cdfe;
            --bg-color: #0d0d24; --card-bg-color: #1a1a3a; --header-bg-color: #1a1a3acc;
        }
        body[data-theme="forest"] {
            --primary-color: #4caf50; --secondary-color: #8d6e63; --light-gray: #3e4d34; --border-color: #5a6e4e; --text-color: #e8f5e9;
            --bg-color: #1b2e1c; --card-bg-color: #2c3e2d; --header-bg-color: #2c3e2dcc;
        }
        body { font-family: var(--font-main); background-color: var(--bg-color); margin: 0; color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .hidden { display: none !important; }
        a { text-decoration: none; color: inherit; }
        .view { animation: fadeIn 0.4s ease-out; }
        header { background-color: var(--header-bg-color); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 10px 20px; position: sticky; top: 0; z-index: 1000; }
        nav { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; gap: 15px; flex-wrap: wrap; }
        nav h1 { margin: 0; font-size: 1.8em; color: var(--primary-color); cursor: pointer; }
        .nav-center { flex-grow: 1; display: flex; justify-content: center; }
        #search-bar { width: 100%; max-width: 400px; padding: 8px 12px; border-radius: 20px; border: 1px solid var(--border-color); background-color: var(--light-gray); font-size: 1em; color: var(--text-color); }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .nav-button { padding: 8px 16px; border: none; border-radius: 6px; background-color: var(--primary-color); color: white; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease; }
        #logoutBtn { background-color: var(--secondary-color); }
        #userInfo { font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .creator-link { font-family: var(--font-code); font-weight: 600; }
        .creator-link:hover { color: var(--primary-color); }
        .feed-controls { max-width: 1200px; margin: 20px auto; padding: 0 10px; display: flex; justify-content: space-between; align-items: center; }
        .feed-tabs button { background: none; border: none; padding: 10px 15px; font-size: 1.1em; font-weight: bold; color: var(--secondary-color); cursor: pointer; border-bottom: 3px solid transparent; }
        .feed-tabs button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .meme-gallery { max-width: 1200px; margin: 20px auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 0 10px; }
        .meme-post { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
        .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 12px 15px 0; }
        .post-image-link img { width: 100%; display: block; background-color: var(--skeleton-bg); cursor: pointer; }
        .post-content { padding: 12px 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .post-meta { font-size: 0.8em; color: var(--secondary-color); }
        .post-meta em { font-style: italic; }
        .post-description { font-size: 0.9em; margin-bottom: 12px; flex-grow: 1; white-space: pre-wrap; }
        .post-actions { display: flex; align-items: center; gap: 16px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .action-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 0; transition: transform 0.2s; position: relative; }
        .action-count { font-weight: bold; font-size: 0.9em; }
        .action-btn.voted { color: var(--primary-color); transform: scale(1.2); }
        .comment-link { margin-left: auto; }
        .post-options-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2em; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; opacity: 0; transition: opacity 0.2s; }
        .meme-post:hover .post-options-btn { opacity: 1; }
        .options-menu { display: none; position: absolute; top: 45px; right: 10px; background: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; }
        .options-menu button { display: block; width: 100%; padding: 10px 15px; text-align: left; background: none; border: none; cursor: pointer; font-size: 0.9em; color: var(--text-color); }
        .options-menu button:hover { background: var(--light-gray); }
        #notifications-bell { position: relative; }
        #notifications-count { position: absolute; top: -5px; right: -8px; background-color: var(--error-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        #notifications-panel { display: none; position: absolute; right: 0; top: 50px; width: 350px; max-height: 400px; overflow-y: auto; background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1001; animation: slideInDown 0.3s ease-out; }
        .notification-item { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .notification-item.unread { font-weight: bold; }
        .notification-item:hover { background-color: var(--light-gray); }
        .toast { position: fixed; bottom: 20px; left: 50%; background-color: #333; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 9999; animation: toastIn 0.5s forwards; transform: translateX(-50%); }
        #profile-view { max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .profile-header { display: flex; align-items: center; flex-wrap: wrap; gap: 30px; padding: 20px; background-color: var(--card-bg-color); border-radius: 8px; }
        .profile-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; }
        #meme-detail-view { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 800px) { #meme-detail-view { grid-template-columns: 2fr 1fr; } }
        #comments-section { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        #comment-form textarea { width: 100%; min-height: 60px; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--light-gray); color: var(--text-color); resize: vertical; box-sizing: border-box; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--card-bg-color); padding: 20px 30px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center; }
        .modal-flex-buttons { display: flex; gap: 10px; margin-top: 10px; }
        #googleLoginBtn { background-color: #db4437; flex: 1; }
        #githubLoginBtn { background-color: #333; flex: 1; }
        @media (max-width: 768px) { nav { .nav-center { order: 3; width: 100%; flex-grow: 0; padding-top: 5px; } .feed-controls { flex-direction: column; gap: 15px; } } }
    </style>
</head>
<body data-theme="light">
    <!-- HTML Structure -->
    <header>
        <nav>
            <h1 id="home-link">MemeDrop</h1>
            <div class="nav-center"><input type="search" id="search-bar" placeholder="Search memes..."></div>
            <div class="nav-right">
                <button id="uploadBtn" class="nav-button hidden">Upload</button>
                <div id="notifications-bell" class="hidden"><button class="action-btn">🔔</button><div id="notifications-count" class="hidden"></div><div id="notifications-panel"></div></div>
                <select id="theme-selector" title="Change Theme"><option value="light">Light</option><option value="dark">Dark</option><option value="vaporwave">Vaporwave</option><option value="forest">Forest</option></select>
                <span id="userInfo" class="hidden"></span>
                <button id="loginPromptBtn" class="nav-button">Login</button>
            </div>
        </nav>
    </header>
    <main>
        <div id="gallery-view" class="view">
            <div class="feed-controls">
                <div class="feed-tabs">
                    <button id="feed-for-you" class="active">For You</button>
                    <button id="feed-new">New</button>
                </div>
            </div>
            <div id="meme-gallery" class="meme-gallery"><p>Loading memes...</p></div>
        </div>
        <div id="profile-view" class="view hidden"></div>
        <div id="meme-detail-view" class="view hidden"></div>
    </main>
    <div id="modal-container"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SETUP & STATE ---
        const firebaseConfig = { apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8", authDomain: "test-6336a.firebaseapp.com", databaseURL: "https://test-6336a-default-rtdb.firebaseio.com", projectId: "test-6336a", storageBucket: "test-6336a.firebasestorage.app", messagingSenderId: "437879418972", appId: "1:437879418972:web:47678bb0b3664edab8f699" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let allMemes = [];
        let currentFeed = 'for-you';
        let notificationListener = null;
        
        const modalContainer = document.getElementById('modal-container');
        const AUTH_HELPER_URL = 'https://fawkesyt.github.io/memedrop-auth/auth.html';
        let authWindow = null;

        // --- UI & RENDERING ---
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'toastOut 0.5s forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        };
        const timeAgo = (timestamp) => {
            const now = new Date();
            const secondsPast = (now.getTime() - timestamp) / 1000;
            if (secondsPast < 60) return `${Math.round(secondsPast)}s ago`;
            if (secondsPast < 3600) return `${Math.round(secondsPast / 60)}m ago`;
            if (secondsPast <= 86400) return `${Math.round(secondsPast / 3600)}h ago`;
            const days = Math.round(secondsPast / 86400);
            return `${days}d ago`;
        };
        const calculateHotScore = (meme) => {
            const likes = meme.likes ? Object.keys(meme.likes).length : 0;
            const dislikes = meme.dislikes ? Object.keys(meme.dislikes).length : 0;
            const score = likes - dislikes;
            const ageInHours = (Date.now() - meme.createdAt) / (1000 * 60 * 60);
            return score / Math.pow(ageInHours + 2, 1.8);
        };
        
        const createMemeElement = (meme) => {
            const post = document.createElement('article');
            post.className = 'meme-post';
            post.dataset.memeId = meme.id;
            const likeCount = meme.likes ? Object.keys(meme.likes).length : 0;
            const dislikeCount = meme.dislikes ? Object.keys(meme.dislikes).length : 0;
            let userVote = null;
            if (currentUser) {
                if (meme.likes && meme.likes[currentUser.uid]) userVote = 'like';
                if (meme.dislikes && meme.dislikes[currentUser.uid]) userVote = 'dislike';
            }
            const isOwner = currentUser && currentUser.uid === meme.creatorId;
            post.innerHTML = `
                ${isOwner ? `<button class="post-options-btn" data-action="toggle-options" aria-label="More options">...</button>
                <div class="options-menu">
                    <button data-action="edit" data-meme-id="${meme.id}">Edit</button>
                    <button data-action="delete" data-meme-id="${meme.id}" style="color: var(--error-color);">Delete</button>
                </div>` : ''}
                <div class="post-header">
                    <a href="?user=${meme.creatorId}" class="creator-link" data-navigo>${meme.creatorName || 'Anonymous'}</a>
                    <span class="post-meta">${timeAgo(meme.createdAt)} ${meme.editedAt ? `<em>(edited)</em>` : ''}</span>
                </div>
                <a class="post-image-link" href="?id=${meme.id}" data-navigo><img src="${meme.imageBase64}" alt="${meme.description || 'A meme'}" loading="lazy"></a>
                <div class="post-content">
                    <p class="post-description">${meme.description || ''}</p>
                    <div class="post-actions">
                        <button class="action-btn like-btn ${userVote === 'like' ? 'voted' : ''}" data-meme-id="${meme.id}">👍</button><span class="action-count">${likeCount}</span>
                        <button class="action-btn dislike-btn ${userVote === 'dislike' ? 'voted' : ''}" data-meme-id="${meme.id}">👎</button><span class="action-count">${dislikeCount}</span>
                        <a href="?id=${meme.id}" class="action-btn comment-link" data-navigo>💬</a><span class="action-count">${meme.commentCount || 0}</span>
                    </div>
                </div>`;
            return post;
        };

        const renderGallery = () => {
            const container = document.getElementById('meme-gallery');
            container.innerHTML = '';
            let memesToDisplay = [...allMemes];
            if (currentFeed === 'for-you') {
                memesToDisplay.sort((a,b) => calculateHotScore(b) - calculateHotScore(a));
            } else { // 'new'
                memesToDisplay.sort((a,b) => b.createdAt - a.createdAt);
            }
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            if (searchTerm) {
                memesToDisplay = memesToDisplay.filter(meme => (meme.description?.toLowerCase() || '').includes(searchTerm) || (meme.creatorName?.toLowerCase() || '').includes(searchTerm));
            }
            if(memesToDisplay.length === 0) {
                 container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">No memes found.</p>';
                 return;
            }
            memesToDisplay.forEach(meme => container.appendChild(createMemeElement(meme)));
        };

        const updateUIForAuthState = (user) => {
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginPromptBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const notificationsBell = document.getElementById('notifications-bell');
            if (user) {
                userInfo.innerHTML = `<a href="?user=${user.uid}" class="creator-link" data-navigo>${user.displayName || 'User'}</a> <button id="logoutBtn" class="nav-button">Logout</button>`;
                userInfo.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                uploadBtn.classList.remove('hidden');
                notificationsBell.classList.remove('hidden');
                listenForNotifications(user.uid);
            } else {
                userInfo.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                uploadBtn.classList.add('hidden');
                notificationsBell.classList.add('hidden');
                if (notificationListener) notificationListener.off();
            }
        };

        const showView = (viewName) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(viewName).classList.remove('hidden');
        };

        const navigate = (path) => {
            window.history.pushState({}, '', path);
            handleNavigation();
        };
        
        const handleNavigation = () => {
            document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none');
            const params = new URLSearchParams(window.location.search);
            const memeId = params.get('id');
            const userId = params.get('user');
            
            if (memeId) {
                showView('meme-detail-view');
                showMemeDetailPage(memeId);
            } else if (userId) {
                showView('profile-view');
                showProfilePage(userId);
            } else {
                showView('gallery-view');
                renderGallery();
            }
        };

        const showProfilePage = async (userId) => {
            showView('profile-view');
            const container = document.getElementById('profile-view');
            container.innerHTML = '<p style="text-align:center; padding: 20px;">Loading profile...</p>';
            try {
                const userSnap = await database.ref(`users/${userId}`).once('value');
                const userData = userSnap.val();
                if (!userData) {
                    container.innerHTML = '<h2>User not found</h2>';
                    return;
                }
                container.innerHTML = `
                    <div class="profile-header">
                        <img src="${userData.photoURL || `https://api.dicebear.com/8.x/initials/svg?seed=${userData.displayName}`}" alt="Profile picture" class="profile-pic">
                        <div class="profile-info">
                            <h2>${userData.displayName}</h2>
                            <p>${userData.bio || 'No bio yet.'}</p>
                        </div>
                    </div>
                    <h3 style="text-align:center; color: var(--secondary-color);">Memes</h3>
                    <div id="user-meme-gallery" class="meme-gallery"></div>
                `;
                const userMemes = allMemes.filter(m => m.creatorId === userId).sort((a,b) => b.createdAt - a.createdAt);
                const userGallery = document.getElementById('user-meme-gallery');
                userGallery.innerHTML = '';
                if(userMemes.length === 0) {
                     userGallery.innerHTML = '<p>This user has not posted any memes.</p>';
                } else {
                     userMemes.forEach(meme => userGallery.appendChild(createMemeElement(meme)));
                }
            } catch (error) {
                container.innerHTML = '<h2>Could not load profile.</h2>';
            }
        };

        const showMemeDetailPage = async (memeId) => {
            showView('meme-detail-view');
            const detailContainer = document.getElementById('meme-detail-view');
            detailContainer.innerHTML = '<p>Loading meme...</p>';
            try {
                const memeSnap = await database.ref(`memes/${memeId}`).once('value');
                const memeData = { id: memeId, ...memeSnap.val() };
                if (!memeData.creatorId) {
                    detailContainer.innerHTML = '<h2>Meme not found or has been deleted.</h2>';
                    return;
                }
                detailContainer.innerHTML = `
                    <div id="meme-detail-card">${createMemeElement(memeData).innerHTML}</div>
                    <div id="comments-section">
                        <h4>Comments</h4>
                        ${currentUser ? `<form id="comment-form"><textarea id="comment-text" placeholder="Add a comment..." required></textarea><button type="submit" class="nav-button">Post</button></form>` : '<p>Please <a href="#" id="login-link-comment">log in</a> to comment.</p>'}
                        <div id="comments-list"></div>
                    </div>
                `;
                loadAndDisplayComments(memeId);
            } catch (error) {
                detailContainer.innerHTML = '<h2>Could not load meme.</h2>';
            }
        };

        const loadAndDisplayComments = (memeId) => {
            const commentsList = document.getElementById('comments-list');
            const commentsRef = database.ref(`comments/${memeId}`).orderByChild('createdAt');
            commentsRef.on('value', snapshot => {
                commentsList.innerHTML = '';
                if (!snapshot.exists()){
                    commentsList.innerHTML = '<p style="color: var(--secondary-color); font-size: 0.9em;">Be the first to comment!</p>';
                }
                const comments = [];
                snapshot.forEach(child => comments.push(child.val()));
                comments.sort((a,b) => b.createdAt - a.createdAt).forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.innerHTML = `<div class="comment-header"><a href="?user=${comment.authorId}" class="creator-link" data-navigo>${comment.authorName}</a> <span class="post-meta">${timeAgo(comment.createdAt)}</span></div><p>${comment.text}</p>`;
                    commentsList.appendChild(commentEl);
                });
            });
        };
        
        const openModal = (modalType, data = {}) => {
            modalContainer.innerHTML = '';
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            let modalHTML = '';
            switch(modalType) {
                case 'auth': modalHTML = `<div class="modal-content"><h2>Login or Sign Up</h2><p>Continue with your preferred service.</p><div class="modal-flex-buttons"><button id="googleLoginBtn">Login with Google</button><button id="githubLoginBtn">Login with GitHub</button></div><button type="button" class="cancel-btn nav-button" style="background:var(--secondary-color); margin-top:20px;">Cancel</button></div>`; break;
                case 'upload': modalHTML = `<div class="modal-content"><h2>Upload a New Meme</h2><form id="uploadForm"><input type="file" id="memeFile" accept="image/*" required><textarea id="memeDescription" placeholder="Add a description..." maxlength="280"></textarea><button type="submit" class="nav-button">Upload</button></form></div>`; break;
                case 'edit': modalHTML = `<div class="modal-content"><h2>Edit Meme</h2><form id="editForm"><textarea id="memeDescription" required maxlength="280">${data.description}</textarea><button type="submit" class="nav-button">Save Changes</button></form></div>`; break;
                case 'confirmDelete': modalHTML = `<div class="modal-content"><h2>Are you sure?</h2><p>This will permanently delete the meme.</p><div class="modal-flex-buttons"><button class="cancel-btn nav-button" style="background:var(--secondary-color)">Cancel</button><button id="confirmDeleteBtn" class="nav-button" style="background:var(--error-color)">Delete</button></div></div>`; break;
            }
            modalOverlay.innerHTML = modalHTML;
            modalContainer.appendChild(modalOverlay);
            attachModalListeners(modalType, data);
        };

        function attachModalListeners(modalType, data = {}) {
            const modal = modalContainer.querySelector('.modal-overlay');
            if (!modal) return;
            modal.addEventListener('click', e => { if (e.target.classList.contains('cancel-btn') || e.target === modal) modal.remove(); });
            
            switch(modalType) {
                case 'auth':
                    const login = (providerName) => {
                       if (authWindow && !authWindow.closed) { authWindow.focus(); return; }
                       authWindow = window.open(`${AUTH_HELPER_URL}?provider=${providerName}`, 'firebaseAuth', 'height=600,width=400');
                    };
                    modal.querySelector('#googleLoginBtn').addEventListener('click', () => login('google'));
                    modal.querySelector('#githubLoginBtn').addEventListener('click', () => login('github'));
                    break;
                case 'upload':
                    modal.querySelector('#uploadForm').addEventListener('submit', e => {
                        e.preventDefault();
                        const file = e.target.querySelector('#memeFile').files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const memeData = { imageBase64: event.target.result, description: e.target.querySelector('#memeDescription').value, creatorId: currentUser.uid, creatorName: currentUser.displayName, createdAt: firebase.database.ServerValue.TIMESTAMP, commentCount: 0 };
                            database.ref('memes').push(memeData).then(() => { modal.remove(); showToast('Meme uploaded!'); });
                        };
                        reader.readAsDataURL(file);
                    });
                    break;
                case 'edit':
                    modal.querySelector('#editForm').addEventListener('submit', e => {
                        e.preventDefault();
                        const newDesc = modal.querySelector('#memeDescription').value;
                        database.ref(`memes/${data.id}`).update({ description: newDesc, editedAt: firebase.database.ServerValue.TIMESTAMP }).then(() => { modal.remove(); showToast('Meme updated!'); });
                    });
                    break;
                case 'confirmDelete':
                    modal.querySelector('#confirmDeleteBtn').addEventListener('click', () => {
                        database.ref(`memes/${data.id}`).remove();
                        database.ref(`comments/${data.id}`).remove();
                        modal.remove();
                        showToast('Meme deleted.');
                        navigate('?'); // Go back to home after delete
                    });
                    break;
            }
        }
        
        // --- EVENT LISTENERS & INIT ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUIForAuthState(user);
            handleNavigation();
        });

        database.ref('memes').on('value', snapshot => {
            const memesData = snapshot.val() || {};
            allMemes = Object.keys(memesData).map(key => ({ id: key, ...memesData[key] }));
            handleNavigation();
        });
        
        window.addEventListener('message', async (event) => {
            if (event.origin !== 'https://fawkesyt.github.io') return;
            if(authWindow) authWindow.close();
            if (event.data.type === 'authSuccess' && event.data.payload.credential) {
                try {
                    const credential = firebase.auth.OAuthProvider.credentialFromJSON(event.data.payload.credential);
                    const result = await auth.signInWithCredential(credential);
                    if (result.additionalUserInfo.isNewUser) {
                        await database.ref('users/' + result.user.uid).set({displayName: result.user.displayName, photoURL: result.user.photoURL, bio: '', createdAt: firebase.database.ServerValue.TIMESTAMP});
                    }
                    modalContainer.innerHTML = '';
                    showToast('Login successful!');
                } catch(err) {
                    showToast('Login failed.', 'error');
                }
            }
        });
        
        document.addEventListener('click', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const memeId = target.dataset.memeId;

            if (target.closest('a[data-navigo]')) { e.preventDefault(); navigate(target.closest('a[data-navigo]').getAttribute('href')); }
            else if (target.id === 'home-link') { e.preventDefault(); navigate('?'); }
            else if (target.id === 'loginPromptBtn') openModal('auth');
            else if (target.id === 'uploadBtn') openModal('upload');
            else if (target.id === 'logoutBtn') auth.signOut().then(() => showToast('Logged out.'));
            else if (target.closest('.feed-tabs button')) {
                document.querySelector('.feed-tabs .active').classList.remove('active');
                target.classList.add('active');
                currentFeed = target.id.replace('feed-', '');
                renderGallery();
            }
            else if (action === 'toggle-options') { target.nextElementSibling.style.display = 'block'; }
            else if (action === 'edit') openModal('edit', allMemes.find(m => m.id === memeId));
            else if (action === 'delete') openModal('confirmDelete', {id: memeId});
            else if (target.closest('.like-btn')) { /* handleVote logic here */ }
            else if (target.closest('.dislike-btn')) { /* handleVote logic here */ }
            else if (target.closest('#comment-form')) {
                e.preventDefault();
                const text = document.getElementById('comment-text').value;
                if (!text.trim()) return;
                const memeIdForComment = new URLSearchParams(window.location.search).get('id');
                database.ref(`comments/${memeIdForComment}`).push({ text, authorId: currentUser.uid, authorName: currentUser.displayName, createdAt: firebase.database.ServerValue.TIMESTAMP })
                    .then(() => {
                        database.ref(`memes/${memeIdForComment}/commentCount`).transaction(count => (count || 0) + 1);
                        document.getElementById('comment-text').value = '';
                    });
            } else {
                if (!target.closest('.options-menu')) document.querySelectorAll('.options-menu').forEach(m => m.style.display = 'none');
            }
        });

        document.getElementById('search-bar').addEventListener('input', renderGallery);
        window.addEventListener('popstate', handleNavigation);
        
        const savedTheme = localStorage.getItem('memedrop-theme') || 'light';
        document.body.dataset.theme = savedTheme;
        document.getElementById('theme-selector').value = savedTheme;
    });
    </script>
</body>
</html>
