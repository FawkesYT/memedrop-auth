<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeDrop Auth</title>
</head>
<body>
    <!-- This body is intentionally left blank. The redirect happens instantly. -->

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8",
            authDomain: "test-6336a.firebaseapp.com",
            databaseURL: "https://test-6336a-default-rtdb.firebaseio.com",
            projectId: "test-6336a",
            storageBucket: "test-6336a.firebasestorage.app",
            messagingSenderId: "437879418972",
            appId: "1:437879418972:web:47678bb0b3664edab8f699"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // This page has a required two-step logic for the redirect flow:
        // 1. First Load: Redirect this window to the login provider.
        // 2. Return Load: After login, the provider redirects back here. We process
        //    the result and send it to the main app.

        try {
            // Check if we are returning from the login provider
            auth.getRedirectResult()
                .then((result) => {
                    // If 'result' exists, the user has successfully logged in and returned.
                    if (result && result.credential) {
                        const credential = result.credential.toJSON();
                        const user = result.user;

                        // Send the successful login data to the main app window and close this one.
                        window.opener.postMessage({
                            type: 'authSuccess',
                            payload: { credential, user }
                        }, window.opener.location.origin);
                        window.close();
                    } else {
                        // If 'result' is null, this is the first time the page has loaded.
                        // We must now redirect to the correct provider.
                        const params = new URLSearchParams(window.location.search);
                        const providerName = params.get('provider');
                        let provider;

                        if (providerName === 'google') {
                            provider = new firebase.auth.GoogleAuthProvider();
                        } else if (providerName === 'github') {
                            provider = new firebase.auth.GithubAuthProvider();
                        }

                        if (provider) {
                            // This is the line that makes it automatic.
                            auth.signInWithRedirect(provider);
                        } else {
                            throw new Error('No authentication provider specified.');
                        }
                    }
                })
                .catch((error) => {
                    console.error("Auth helper error:", error);
                    window.opener.postMessage({ type: 'authError', message: error.message }, window.opener.location.origin);
                    window.close();
                });
        } catch (error) {
            // This catches synchronous errors, like a missing provider.
            console.error("Auth helper setup error:", error);
            window.opener.postMessage({ type: 'authError', message: error.message }, '*');
            window.close();
        }
    </script>
</body>
</html>
