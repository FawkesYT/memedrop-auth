<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeDrop Auth</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            text-align: center;
        }
        .container {
            padding: 2rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
        button {
            font-size: 1rem;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #googleBtn { background-color: #db4437; }
        #githubBtn { background-color: #333; }
        button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>

    <div id="loading-container">
        <p>Please wait...</p>
    </div>

    <div id="auth-container" class="hidden">
        <h2>Complete Sign-in</h2>
        <p>Click below to continue.</p>
        <button id="auth-button">Continue</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8",
            authDomain: "test-6336a.firebaseapp.com",
            databaseURL: "https://test-6336a-default-rtdb.firebaseio.com",
            projectId: "test-6336a",
            storageBucket: "test-6336a.firebasestorage.app",
            messagingSenderId: "437879418972",
            appId: "1:437879418972:web:47678bb0b3664edab8f699"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const loadingContainer = document.getElementById('loading-container');
        const authContainer = document.getElementById('auth-container');
        const authButton = document.getElementById('auth-button');

        const params = new URLSearchParams(window.location.search);
        const providerName = params.get('provider');
        let provider;

        if (providerName === 'google') {
            provider = new firebase.auth.GoogleAuthProvider();
            authButton.textContent = 'Continue with Google';
            authButton.id = 'googleBtn';
        } else if (providerName === 'github') {
            provider = new firebase.auth.GithubAuthProvider();
            authButton.textContent = 'Continue with GitHub';
            authButton.id = 'githubBtn';
        } else {
            loadingContainer.innerHTML = '<p>Error: No authentication provider specified.</p>';
            window.opener.postMessage({ type: 'authError', message: 'No provider specified.' }, '*');
        }
        
        // If we have a provider, show the button and wait for a click.
        // This is the CRUCIAL step to avoid popup blockers.
        if (provider) {
            loadingContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');

            authButton.addEventListener('click', () => {
                // Now that the user has clicked, we can safely open the popup.
                authContainer.classList.add('hidden');
                loadingContainer.classList.remove('hidden');

                auth.signInWithPopup(provider)
                    .then((result) => {
                        const credential = result.credential.toJSON(); 
                        const user = result.user;

                        window.opener.postMessage({ 
                            type: 'authSuccess', 
                            payload: { credential, user } 
                        }, window.opener.location.origin);
                        window.close();
                    })
                    .catch((error) => {
                        console.error("Auth helper error:", error);
                        window.opener.postMessage({ type: 'authError', message: error.message }, window.opener.location.origin);
                        window.close();
                    });
            });
        }
    </script>
</body>
</html>
