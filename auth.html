<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeDrop Auth</title>
</head>
<body>
    <!-- This page is a utility and should have no visible content. -->
    <!-- The logic runs instantly. -->

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8",
            authDomain: "test-6336a.firebaseapp.com",
            databaseURL: "https://test-6336a-default-rtdb.firebaseio.com",
            projectId: "test-6336a",
            storageBucket: "test-6336a.firebasestorage.app",
            messagingSenderId: "437879418972",
            appId: "1:437879418972:web:47678bb0b3664edab8f699"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const SESSION_KEY = 'memedrop_awaiting_redirect';

        // Check if our flag is set in sessionStorage.
        const isAwaitingRedirect = sessionStorage.getItem(SESSION_KEY);

        // --- SCENARIO 1: RETURN TRIP ---
        // If the flag is set, it means we are returning from the login provider.
        if (isAwaitingRedirect === 'true') {
            
            // Remove the flag immediately to prevent re-triggering.
            sessionStorage.removeItem(SESSION_KEY);

            // Get the authentication result.
            auth.getRedirectResult()
                .then((result) => {
                    if (result && result.credential) {
                        // SUCCESS! We have the user's data.
                        const credential = result.credential.toJSON();
                        const user = result.user;
                        
                        // Send the data back to the main app window.
                        window.opener.postMessage({
                            type: 'authSuccess',
                            payload: { credential, user }
                        }, window.opener.location.origin);

                    } else {
                        // The user may have cancelled the login on the provider's page.
                        throw new Error("Authentication was cancelled or did not complete.");
                    }
                })
                .catch((error) => {
                    // Handle any errors during the process.
                    console.error("Auth helper error on return:", error);
                    window.opener.postMessage({ type: 'authError', message: error.message }, window.opener.location.origin);
                })
                .finally(() => {
                    // No matter what, close the popup window on the return trip.
                    window.close();
                });

        // --- SCENARIO 2: INITIAL TRIP ---
        // If the flag is not set, this is the first time the page has loaded.
        } else {
            try {
                const params = new URLSearchParams(window.location.search);
                const providerName = params.get('provider');
                let provider;

                if (providerName === 'google') {
                    provider = new firebase.auth.GoogleAuthProvider();
                } else if (providerName === 'github') {
                    provider = new firebase.auth.GithubAuthProvider();
                }

                if (provider) {
                    // Set the flag BEFORE we redirect away.
                    sessionStorage.setItem(SESSION_KEY, 'true');
                    
                    // Redirect this window to the login provider.
                    auth.signInWithRedirect(provider);
                } else {
                    throw new Error('No authentication provider specified in URL.');
                }
            } catch (error) {
                // Handle initial setup errors.
                console.error("Auth helper setup error:", error);
                window.opener.postMessage({ type: 'authError', message: error.message }, '*');
                window.close();
            }
        }
    </script>
</body>
</html>
