<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeDrop Auth</title>
</head>
<body>
    <!-- The body is intentionally blank. The logic runs instantly. -->

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8",
            authDomain: "test-6336a.firebaseapp.com",
            databaseURL: "https://test-6336a-default-rtdb.firebaseio.com",
            projectId: "test-6336a",
            storageBucket: "test-6336a.firebasestorage.app",
            messagingSenderId: "437879418972",
            appId: "1:437879418972:web:47678bb0b3664edab8f699"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Use sessionStorage to track if we are in the middle of a redirect flow.
        // This is the key to preventing the infinite loop.
        const isAwaitingRedirect = sessionStorage.getItem('isAwaitingRedirect');
        
        // If the flag is set, we are on the RETURN trip from the provider.
        if (isAwaitingRedirect) {
            // IMPORTANT: Remove the flag immediately.
            sessionStorage.removeItem('isAwaitingRedirect');

            auth.getRedirectResult()
                .then((result) => {
                    if (result && result.credential) {
                        // Success! Send the data to the main app.
                        const credential = result.credential.toJSON();
                        const user = result.user;
                        window.opener.postMessage({
                            type: 'authSuccess',
                            payload: { credential, user }
                        }, window.opener.location.origin);
                    } else {
                        // This case happens if the user closes the provider window
                        // or if there's an error during the redirect.
                        throw new Error("Authentication was cancelled or failed on return.");
                    }
                })
                .catch((error) => {
                    // Catch any error and report it back to the main app.
                    console.error("Auth helper error on return:", error);
                    window.opener.postMessage({ type: 'authError', message: error.message }, window.opener.location.origin);
                })
                .finally(() => {
                    // Always close the window on the return trip.
                    window.close();
                });
        } 
        // If the flag is NOT set, this is the INITIAL trip.
        else {
            try {
                const params = new URLSearchParams(window.location.search);
                const providerName = params.get('provider');
                let provider;

                if (providerName === 'google') {
                    provider = new firebase.auth.GoogleAuthProvider();
                } else if (providerName === 'github') {
                    provider = new firebase.auth.GithubAuthProvider();
                }

                if (provider) {
                    // IMPORTANT: Set the flag BEFORE redirecting.
                    sessionStorage.setItem('isAwaitingRedirect', 'true');
                    // Now, redirect this window to the login provider.
                    auth.signInWithRedirect(provider);
                } else {
                    throw new Error('No authentication provider specified.');
                }
            } catch (error) {
                // Catch setup errors and report them back.
                console.error("Auth helper setup error:", error);
                window.opener.postMessage({ type: 'authError', message: error.message }, '*');
                window.close();
            }
        }
    </script>
</body>
</html>
