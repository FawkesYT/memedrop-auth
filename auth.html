<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeDrop Auth - Google</title>
    <style>
        body { font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f0f0; text-align: center; }
        .container { padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; margin: 0 auto 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { color: #333; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <p id="status-message">Processing authentication...</p>
        <p><small>This window should close automatically.</small></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // CRITICAL: This firebaseConfig MUST BE IDENTICAL to the one in your index.html
        const firebaseConfig = { 
            apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8", 
            authDomain: "test-6336a.firebaseapp.com", 
            databaseURL: "https://test-6336a-default-rtdb.firebaseio.com", 
            projectId: "test-6336a", 
            storageBucket: "test-6336a.appspot.com", // Matches index.html original
            messagingSenderId: "437879418972", 
            appId: "1:437879418972:web:47678bb0b3664edab8f699" 
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const SESSION_KEY = 'memedrop_awaiting_google_redirect_v2'; // Use a distinct key
        const statusMessageEl = document.getElementById('status-message');

        console.log("Auth Helper Loaded. Firebase Initialized with config:", firebaseConfig);

        const postMessageToOpener = (message) => {
            if (window.opener && window.opener.location && window.opener.location.origin) {
                console.log("Auth Helper: Posting message to opener:", message, "Target Origin:", window.opener.location.origin);
                window.opener.postMessage(message, window.opener.location.origin);
            } else {
                console.warn("Auth Helper: Cannot post message - window.opener or its origin is not accessible.", message);
                statusMessageEl.textContent = "Error: Could not communicate with the main application window. Please close this window and try again.";
                statusMessageEl.classList.add("error");
            }
        };

        // Check if our flag is set in sessionStorage.
        const isAwaitingRedirect = sessionStorage.getItem(SESSION_KEY);
        console.log("Auth Helper: isAwaitingRedirect flag from sessionStorage:", isAwaitingRedirect);


        // --- SCENARIO 1: RETURN TRIP (after Google redirect) ---
        if (isAwaitingRedirect === 'true') {
            console.log("Auth Helper: Return trip detected.");
            statusMessageEl.textContent = "Finalizing Google sign-in...";
            sessionStorage.removeItem(SESSION_KEY); // Clear the flag immediately

            auth.getRedirectResult()
                .then((result) => {
                    console.log("Auth Helper: getRedirectResult full result object:", result);
                    if (result && result.credential) {
                        const credential = result.credential.toJSON();
                        console.log("Auth Helper: Authentication successful. Credential:", credential);
                        postMessageToOpener({
                            type: 'authSuccess',
                            payload: { credential }
                        });
                        statusMessageEl.textContent = "Sign-in successful! Closing window...";
                    } else {
                        console.warn("Auth Helper: No redirect result or credential found. Result object was:", result);
                        postMessageToOpener({
                            type: 'authError',
                            message: "Authentication cancelled or no redirect result found."
                        });
                        statusMessageEl.textContent = "Sign-in cancelled or failed. Please try again from the main app.";
                        statusMessageEl.classList.add("error");
                    }
                })
                .catch((error) => {
                    console.error("Auth Helper: Error during getRedirectResult:", error, "Code:", error.code, "Message:", error.message);
                    postMessageToOpener({
                        type: 'authError',
                        message: error.message || "An unknown error occurred during sign-in.",
                        code: error.code
                    });
                    statusMessageEl.textContent = `Sign-in error: ${error.message}. You can close this window.`;
                    statusMessageEl.classList.add("error");
                })
                .finally(() => {
                    console.log("Auth Helper: Closing window after return trip processing.");
                    setTimeout(() => window.close(), 2000); // Give a bit more time for message and visibility
                });

        // --- SCENARIO 2: INITIAL TRIP (when popup is first opened) ---
        } else {
            console.log("Auth Helper: Initial trip detected.");
            try {
                const params = new URLSearchParams(window.location.search);
                const providerName = params.get('provider');
                console.log("Auth Helper: Requested provider from URL params:", providerName);

                if (providerName === 'google') {
                    statusMessageEl.textContent = "Redirecting to Google for sign-in...";
                    const provider = new firebase.auth.GoogleAuthProvider();
                    // Optional: Add custom parameters or scopes if needed
                    // provider.addScope('profile');
                    // provider.addScope('email');
                    // provider.setCustomParameters({ 'prompt': 'select_account' }); // Example

                    console.log("Auth Helper: Setting session flag and initiating signInWithRedirect to Google.");
                    sessionStorage.setItem(SESSION_KEY, 'true'); // Set flag BEFORE redirect
                    auth.signInWithRedirect(provider);
                    // The page will redirect here, so code below this line in this block might not execute
                    // immediately unless signInWithRedirect itself throws a synchronous error.
                } else {
                    throw new Error(`Unsupported or no authentication provider specified. Expected "google", got "${providerName}".`);
                }
            } catch (error) {
                console.error("Auth Helper: Error during initial setup:", error);
                statusMessageEl.textContent = `Setup error: ${error.message}. Please close this window.`;
                statusMessageEl.classList.add("error");
                postMessageToOpener({
                    type: 'authError',
                    message: error.message || "Auth helper setup failed."
                });
                console.log("Auth Helper: Closing window due to setup error.");
                setTimeout(() => window.close(), 3000);
            }
        }
    </script>
</body>
</html>
