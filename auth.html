<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemeDrop Auth</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            text-align: center;
        }
        p {
            font-size: 1.1rem;
            color: #333;
        }
    </style>
</head>
<body>
    <p>Redirecting to your login provider...</p>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEDWYFwpeSttykkIR60kiCojA5S5UdaA8",
            authDomain: "test-6336a.firebaseapp.com",
            databaseURL: "https://test-6336a-default-rtdb.firebaseio.com",
            projectId: "test-6336a",
            storageBucket: "test-6336a.firebasestorage.app",
            messagingSenderId: "437879418972",
            appId: "1:437879418972:web:47678bb0b3664edab8f699"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // This page now has a two-step job:
        // 1. First load: Redirect to the provider (Google/GitHub).
        // 2. Second load (after provider redirect): Process the result and send it back.

        try {
            const params = new URLSearchParams(window.location.search);
            const providerName = params.get('provider');
            let provider;

            if (providerName === 'google') {
                provider = new firebase.auth.GoogleAuthProvider();
            } else if (providerName === 'github') {
                provider = new firebase.auth.GithubAuthProvider();
            }

            if (provider) {
                // Check if we are returning from a redirect.
                auth.getRedirectResult()
                    .then((result) => {
                        // If result exists, it means we have successfully returned from the provider.
                        if (result && result.credential) {
                            const credential = result.credential.toJSON();
                            const user = result.user;

                            // Send the successful login data to the main app window.
                            window.opener.postMessage({
                                type: 'authSuccess',
                                payload: { credential, user }
                            }, window.opener.location.origin);
                            window.close();
                        } else {
                            // If no result, this is the first time the page has loaded.
                            // Immediately redirect this window to the provider's auth page.
                            auth.signInWithRedirect(provider);
                        }
                    })
                    .catch((error) => {
                        // Handle errors from getRedirectResult.
                        console.error("Auth helper error during getRedirectResult:", error);
                        window.opener.postMessage({ type: 'authError', message: error.message }, window.opener.location.origin);
                        window.close();
                    });
            } else {
                throw new Error('No authentication provider specified.');
            }
        } catch (error) {
            // Handle any other errors (like no provider in URL).
            document.body.innerHTML = `<p>Error: ${error.message}</p>`;
            window.opener.postMessage({ type: 'authError', message: error.message }, '*');
        }
    </script>
</body>
</html>
